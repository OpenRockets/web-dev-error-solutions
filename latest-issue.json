[{"body":"\n## Description of the Error\n\nDevelopers frequently encounter issues when storing large amounts of data within Firestore, particularly when dealing with rich text posts containing images or videos.  Firestore has document size limits (currently 1 MB). Attempting to store a post exceeding this limit results in an error, preventing successful data persistence.  This error usually manifests as a `FAILED_PRECONDITION` error in your Firebase console or client-side error logs.  The error message might not explicitly mention the size limit but rather indicate a document being too large.  This can lead to application crashes or data loss if not handled properly.\n\n\n## Fixing Step-by-Step\n\nThis example demonstrates how to handle large posts by storing the main text content directly in Firestore, but storing media (images in this case) in Firebase Storage and only referencing them in Firestore.\n\n\n**Step 1:  Project Setup**\n\nEnsure you have the Firebase Admin SDK and Firebase Storage SDK installed.  If using client-side code (e.g., React, Angular, etc.), install the appropriate client SDKs.\n\n```bash\nnpm install firebase @firebase/storage\n```\n\n**Step 2: Store Images in Firebase Storage**\n\nThis function uploads an image to Firebase Storage and returns the download URL.\n\n```javascript\nimport { getStorage, ref, uploadBytesResumable, getDownloadURL } from \"firebase/storage\";\n\nasync function uploadImage(image, postId) {\n  const storage = getStorage();\n  const storageRef = ref(storage, `posts/${postId}/${image.name}`); // Organize images by post ID\n  const uploadTask = uploadBytesResumable(storageRef, image);\n\n  return new Promise((resolve, reject) => {\n    uploadTask.on('state_changed', \n      (snapshot) => {\n        // Observe state change events such as progress, pause, and resume\n        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded\n        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;\n        console.log('Upload is ' + progress + '% done');\n        switch (snapshot.state) {\n          case 'paused':\n            console.log('Upload is paused');\n            break;\n          case 'running':\n            console.log('Upload is running');\n            break;\n        }\n      }, \n      (error) => {\n        reject(error); // Handle unsuccessful uploads\n      }, \n      () => {\n        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {\n          resolve(downloadURL);\n        });\n      }\n    );\n  });\n}\n```\n\n\n**Step 3: Store Post Data in Firestore**\n\nThis function creates a Firestore document containing post metadata and image URLs.\n\n```javascript\nimport { getFirestore, collection, addDoc } from \"firebase/firestore\";\n\nasync function createPost(postData, imageURLs) {\n  const db = getFirestore();\n  const docRef = await addDoc(collection(db, \"posts\"), {\n    title: postData.title,\n    content: postData.content, // Main text content\n    images: imageURLs, // Array of image URLs from Storage\n    timestamp: new Date(), // Add a timestamp\n  });\n  console.log(\"Document written with ID: \", docRef.id);\n}\n```\n\n\n**Step 4: Integrate and Use the Functions**\n\n\n```javascript\n// ... (Import necessary functions and modules) ...\n\nasync function handlePostCreation(postData, images) {\n  const imageURLs = [];\n  try {\n      for (const image of images) {\n          const url = await uploadImage(image, postData.id); // Assuming postData has an id\n          imageURLs.push(url);\n      }\n      await createPost(postData, imageURLs);\n  } catch (error) {\n    console.error(\"Error creating post:\", error);\n    // Handle error appropriately (e.g., display an error message to the user)\n  }\n}\n\n\n// Example usage:\nconst postData = {\n  id: 'uniquePostId', //Generate unique ID\n  title: \"My Awesome Post\",\n  content: \"This is the main text content of my post.\",\n};\n\nconst images = [ /* Array of File objects representing images */ ];\n\nhandlePostCreation(postData, images);\n\n```\n\n\n## Explanation\n\nThis solution leverages Firebase Storage to handle large files (images) separately from the main post data stored in Firestore.  By referencing the image URLs in Firestore, we avoid exceeding the document size limits. This approach maintains data integrity and improves performance as Firestore only needs to retrieve smaller, metadata-rich documents.\n\n## External References\n\n* [Firestore Data Storage Limits](https://firebase.google.com/docs/firestore/quotas)\n* [Firebase Storage Documentation](https://firebase.google.com/docs/storage)\n* [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup)\n\n\nCopyrights (c) OpenRockets Open-source Network. Free to use, copy, share, edit or publish.\n","number":2925,"title":"Handling Firestore Data Storage Limits for Large Posts"}]
